<script type="text/html" data-template-name="emerge">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>

    <div class="form-row">
        <label for="node-input-typed-complete"><i class="fa fa-sign-in"></i> Merge</label>
        <input id="node-input-typed-complete" type="text" style="width: 70%">
        <input id="node-input-complete" type="hidden">
        <input id="node-input-targetType" type="hidden">
    </div>

    <div class="form-row" style="margin-bottom:0;white-space:nowrap;">
        <label><i class="fa fa-list"></i> Until Conditions</label>
    </div>
    <div class="form-row node-input-conditions-container-row">
        <ol id="node-input-conditions-container"></ol>
    </div>
</script>

<script type="text/html" data-help-name="emerge">
  <p>Merges msg objects until all defined property conditions are met before passing the combined msg along and clearing the internal buffer.</p>

  <p>By default, string <b><i>from</i></b> and <b><i>to</i></b>
  methods apply to the <code>msg.payload</code> property but may be set to any
  property of <code>global</code>, <code>flow</code>, or <code>msg</code>
  contexts.</p>

  <h3>Details</h3>
  <p>Some details...</p>

  <h3>References</h3>
  <ul>
    <li>The official <a href="https://github.com/Steveorevo/node-red-contrib-emerge" target=_blank>node-red-contrib-emerge</a> project on GitHub.</li>
  </ul>
</script>

<script type="text/javascript">
    RED.nodes.registerType('emerge',{
        category: 'sequence',
        color:"#E2D96E",
        defaults: {
            name: {value:""},
            conditions: [{

            }],
            complete: {value:"false", required:true},
            targetType: {value:undefined}
        },
        inputs:1,
        outputs:1,
        icon: "font-awesome/fa-ellipsis-h",
        label: function() {
            return this.name || "emerge";
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {

            // The message object to be merged
            var fullType = {
                value: "full",
                label: RED._("node-red:debug.msgobj"),
                hasValue: false
            };
            $("#node-input-typed-complete").typedInput({
                default: "msg",
                types:['msg', fullType],
                typeField: $("#node-input-targetType")
            });
            if ((this.targetType === "full") || this.complete === "true" || this.complete === true) {
                // show complete message object
                $("#node-input-typed-complete").typedInput('type','full');
            } else {
                var property = (!this.complete||(this.complete === "false")) ? "payload" : this.complete+"";
                $("#node-input-typed-complete").typedInput('type','msg');
                $("#node-input-typed-complete").typedInput('value',property);
            }
            $("#node-input-typed-complete").on('change',function() {
                if ($("#node-input-typed-complete").typedInput('type') === 'msg' &&
                    $("#node-input-typed-complete").typedInput('value') === ''
                ) {
                    $("#node-input-typed-complete").typedInput('value','payload');
                }
            });

            // The conditions editable list
            var operators = [
                { name: "eq", label: "==" },
                { name: "neq", label: "!=" },
                { name: "lt", label: "<" },
                { name: "lte", label: "<=" },
                { name: "gt", label: ">" },
                { name: "gte", label: ">=" },
                { name: "gte", label: ">=" },
                { name: "cont", label: "contains" },
                { name: "ncont", label: "not contains" },
                { name: "true", label: "is true" },
                { name: "false", label: "is false" },
                { name: "null", label: "is null" },
                { name: "nnull", label: "is not null" },
                { name: "undef", label: "is undefined" },
                { name: "nundef", label: "is not undefined" }
            ];
            $("#node-input-conditions-container").css('min-height','150px').css('min-width','450px').editableList({
                addItem: function(container, i, opt) {
                    var row = $('<div/>', {class:"node-input-condition-applied"}).appendTo(container);
                    
                    var propValInput = $('<input/>',{
                        class:"node-input-condition-property-value",
                        type:"text",
                        style: "width:180px;margin-right:10px;"
                    }).appendTo(row).typedInput({default:'msg',types:['msg','flow','global']});
                    
                    var selectField = $('<select/>', {
                        class: "node-input-condition-type",
                        style: "width:118px;margin-right:10px;"
                    }).appendTo(row);
                    for (var i=0; i < operators.length; i++) {
                      selectField.append($("<option></option>").val(operators[i].name).text(operators[i].label));
                    }

                    var propCompare = $('<input/>',{
                        class:"node-input-condition-property-value",
                        type:"text",
                        style: "width:118px;margin-right:10px;"
                    }).appendTo(row).typedInput({default:'msg',types:['msg','flow','global','str','num','bool','json','bin','date','env']});
                },
                removable: true,
                sortable: true
            });
        },
        oneditresize: function() {

        },
        oneditsave: function() {

        }
    });
</script>
